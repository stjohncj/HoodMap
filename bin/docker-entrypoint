#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

# If running the rails server (either directly or via docker-start wrapper)
# then create or migrate existing database
if [[ "${@: -2:1}" == "./bin/rails" && "${@: -1:1}" == "server" ]] || [[ "$1" == "./bin/docker-start" ]]; then
  echo "Setting up database..."

  # Wait for database to be ready (Railway private networking takes a moment)
  echo "Waiting for database connection..."

  # Extract database connection details from DATABASE_URL
  # Format: postgresql://user:pass@host:port/database
  if [ -n "$DATABASE_URL" ]; then
    DB_HOST=$(echo $DATABASE_URL | sed -e 's|.*@\(.*\):.*|\1|')
    DB_PORT=$(echo $DATABASE_URL | sed -e 's|.*:\([0-9]*\)/.*|\1|')

    MAX_RETRIES=30
    RETRY_COUNT=0

    # Use pg_isready for fast, lightweight database checks
    until pg_isready -h "$DB_HOST" -p "$DB_PORT" -q || [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
      RETRY_COUNT=$((RETRY_COUNT+1))
      # Only log every 5th attempt to avoid Railway rate limit
      if [ $((RETRY_COUNT % 5)) -eq 0 ]; then
        echo "Database not ready yet (attempt $RETRY_COUNT/$MAX_RETRIES), waiting..."
      fi
      sleep 2
    done
  else
    echo "WARNING: DATABASE_URL not set, skipping connection check"
    RETRY_COUNT=0
  fi

  if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
    echo "ERROR: Could not connect to database after $MAX_RETRIES attempts"
    exit 1
  fi

  echo "Database connection established after $RETRY_COUNT attempts!"

  # Check if HOOD_MAP_REGENERATE_DATA is set to regenerate the database
  if [ -n "${HOOD_MAP_REGENERATE_DATA}" ]; then
    echo "HOOD_MAP_REGENERATE_DATA is set - running db:reset..."
    ./bin/rails db:reset
    echo "Database reset complete. Unsetting HOOD_MAP_REGENERATE_DATA for next startup..."
    unset HOOD_MAP_REGENERATE_DATA
  else
    ./bin/rails db:prepare
  fi

  echo "Database setup complete"
fi

exec "${@}"
